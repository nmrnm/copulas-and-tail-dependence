---
title: "copulaWithTailDependence"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(copula)

```
note that there there is dr.reumans code here as well (see ForNoah20200601.R)
```{r}

newCopulaWithTailDependece<-function(n,dim,rho,thresh_lo,thresh_hi)
{
  U<-runif(n)
  ncop<-normalCopula(rho,dim=dim) #this is the copula of a multivariate normal with covariance matrix having 1s on
  #the diagonal and all rhos in all off-diagonal positions
  res<-rCopula(n,ncop)
  res<-(thresh_hi-thresh_lo)*res+thresh_lo
  res[U>thresh_hi,]<-rep(U[U>thresh_hi],times=dim) #this line takes the rows of res for which the corresponding
  #entry of U is bigger than thresh_hi and replaces both entries of those rows by the corresponding value of U
  res[U<thresh_lo,]<-rep(U[U<thresh_lo],times=dim) #this line takes the rows of res for which the corresponding
  #entry of U is smaller than thresh_lo and replaces both entries of those rows by the corresponding value of U
  return(res)
}


findNormalCopulaParam <- function(numSamples,dim,varSumToMatch){
    fOptim <-function(rho){
     #varSum is the sum of all entries in the covariance matrix 
     # and the below formula gets that sum in a closed formula way
     varSum <- dim*(dim-1)*rho + dim
     return(abs(varSum-varSumToMatch))
    }
    # $minimum is the x value for which the minimum is achieved (note that optimize returns a list) 
    return(optimize(fOptim,c(0,1),lower=0,upper=1,maximum=FALSE)$minimum)
}
```


```{r}
n<-10000
dim<-3
rho<-0
thresh_hi<-.9
thresh_lo<-.1
res<-newCopulaWithTailDependece(n,dim,rho,thresh_lo,thresh_hi)
dim(res)
plot(res[,1],res[,2],type="p")
plot(res[,1],res[,3],type="p")

res<-qnorm(res)
hist(res[,1],50)
hist(res[,2],50)

covMatrix <- matrix(data=rep(0,times=dim*dim),nrow=dim,byrow=TRUE)

varSum <- 0 
for(i in 1:dim){
  for(j in 1:(dim)){
   covMatrix[i,j] <- cov(res[,i],res[,j])
   varSum <- varSum + covMatrix[i,j]
  }
}

print(covMatrix)
print(varSum)

rho <- findNormalCopulaParam(numSamples, dim, varSum)
newNormalCop <- normalCopula(param = rho)
myNormCop <- rCopula(n, newNormalCop)

plot(res[,1],res[,2],type="p")
plot(myNormCop[,1],myNormCop[,2])
```

```{r}


```